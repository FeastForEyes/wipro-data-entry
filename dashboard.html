<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wipro Hiring Dashboard & Analytics</title>
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #8a3ffc;
            --primary-color-hover: #a166ff;
            --secondary-color: #00b6cb;
            --accent-color: #ff7eb6;
            --success-color: #42be65;
            --warning-color: #f1c21b;
            --error-color: #fa4d56;
            
            --bg-color-start: #0c0c0c;
            --bg-color-mid: #121212;
            --bg-color-end: #000000;
            
            --glass-bg: rgba(28, 28, 32, 0.85);
            --glass-border: rgba(255, 255, 255, 0.12);
            
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #8d8d8d;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
            
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            --transition-fast: 0.15s;
            --transition-medium: 0.3s;
            --transition-slow: 0.45s;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color-hover);
        }

        html, body {
            overflow-x: hidden; /* Prevent horizontal scroll */
            overflow-y: auto; /* Allow vertical scroll on main page */
        }

        body {
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--bg-color-start), var(--bg-color-mid), var(--bg-color-end));
            background-attachment: fixed;
            min-height: 100vh;
            padding: var(--spacing-md);
            line-height: 1.5;
        }
        
        .container { 
            max-width: 1800px; 
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        h1, h2, h3, h4 {
            font-weight: 600;
            line-height: 1.3;
            text-transform: capitalize;
        }
        
        h1 { 
            text-align: center; 
            margin-block: var(--spacing-sm) var(--spacing-xl); 
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.5px;
        }
        
        /* Navigation and Filters */
        nav { 
            background: var(--glass-bg); 
            backdrop-filter: blur(15px); 
            border: 1px solid var(--glass-border); 
            border-radius: var(--border-radius-lg); 
            padding: var(--spacing-md);
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-md);
            box-shadow: var(--shadow-md);
        }
        
        #stats-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: var(--spacing-md); 
            padding-bottom: var(--spacing-md); 
            border-bottom: 1px solid var(--glass-border); 
        }
        
        .stat-item { 
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-secondary); 
            font-size: 0.9rem; 
            padding: var(--spacing-xs) var(--spacing-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius-sm);
        }
        
        .stat-item span { 
            color: var(--text-primary); 
            font-weight: 600; 
            font-size: 1rem; 
        }
        
        #filter-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: var(--spacing-md); 
            align-items: center; 
            justify-content: space-between;
        }

        #program-filters {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            justify-content: center;
        }
        
        .filter-btn { 
            background-color: rgba(255, 255, 255, 0.08); 
            border: 1px solid var(--glass-border); 
            color: var(--text-secondary); 
            padding: var(--spacing-xs) var(--spacing-md); 
            border-radius: var(--border-radius-sm); 
            cursor: pointer; 
            font-weight: 500; 
            transition: all var(--transition-medium); 
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .filter-btn:hover { 
            background-color: rgba(255, 255, 255, 0.15); 
            color: var(--text-primary); 
            transform: translateY(-1px);
        }
        
        .filter-btn.active { 
            background-color: var(--primary-color); 
            border-color: var(--primary-color); 
            color: white; 
            box-shadow: 0 4px 12px rgba(138, 63, 252, 0.3);
        }
        
        .action-button { /* General style for action buttons */
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color)); 
            border: none; 
            color: white; 
            padding: var(--spacing-sm) var(--spacing-md); 
            border-radius: var(--border-radius-sm); 
            cursor: pointer; 
            font-weight: 600; 
            transition: all var(--transition-medium); 
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .action-button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px rgba(255, 126, 182, 0.3);
        }

        /* Style for the new Back Button */
        .nav-back-btn {
            background: linear-gradient(45deg, var(--secondary-color), #00d4a1);
            order: -1; /* Puts it on the far left on desktop */
        }
        .nav-back-btn:hover {
            box-shadow: 0 6px 16px rgba(0, 182, 203, 0.3);
        }
        
        /* Main Dashboard Container */
        #dashboardContainer { 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border); 
            border-radius: var(--border-radius-lg); 
            padding: var(--spacing-md);
            box-shadow: var(--shadow-md);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .table-wrapper { 
            max-height: 60vh; 
            overflow: auto;
            border-radius: var(--border-radius-sm);
            position: relative;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 800px;
        }
        
        th, td { 
            padding: var(--spacing-sm) var(--spacing-md); 
            text-align: left; 
            border-bottom: 1px solid var(--glass-border); 
            font-size: 0.85rem;
        }
        
        th { 
            position: sticky; 
            top: 0; 
            background: rgba(18, 18, 18, 0.95); 
            backdrop-filter: blur(10px); 
            color: var(--text-secondary); 
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }
        
        tbody tr:hover { 
            background-color: rgba(255, 255, 255, 0.05); 
        }
        
        td {
            color: var(--text-secondary);
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        /* Modal Styles */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(10px); 
            z-index: 1000; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            opacity: 0; 
            transition: opacity var(--transition-medium); 
            padding: var(--spacing-md);
            overflow-y: auto;
        }
        
        .modal-overlay.visible { 
            display: flex; 
            opacity: 1; 
        }
        
        .modal-content { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            border-radius: var(--border-radius-lg); 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            box-shadow: var(--shadow-xl); 
            transform: scale(0.95); 
            transition: transform var(--transition-medium); 
            overflow: hidden;
        }
        
        #analytics-modal-content {
            max-width: 1600px;
            height: 95vh; 
        }

        #ai-chat-modal-content, #initial-note-modal-content {
            max-width: 600px; 
            height: fit-content;
            max-height: 90vh;
        }

        .modal-overlay.visible .modal-content { 
            transform: scale(1); 
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--glass-border); 
            background: rgba(18, 18, 18, 0.8);
            flex-shrink: 0;
        }
        
        .modal-header h2 { 
            color: var(--primary-color); 
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .modal-close-btn { 
            background: var(--primary-color); 
            border: none; 
            color: white; 
            padding: var(--spacing-xs) var(--spacing-md); 
            border-radius: var(--border-radius-sm); 
            cursor: pointer; 
            font-weight: 600; 
            transition: background-color var(--transition-fast); 
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .modal-close-btn:hover { 
            background: var(--primary-color-hover); 
        }
        
        .modal-body { 
            padding: var(--spacing-lg); 
            overflow-y: auto; 
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .modal-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: flex-end;
            background: rgba(18, 18, 18, 0.8);
            flex-shrink: 0;
        }
        
        /* Chart Styles */
        .chart-section {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-md);
        }
        
        .chart-wrapper { 
            background: rgba(0, 0, 0, 0.2); 
            padding: var(--spacing-md); 
            border-radius: var(--border-radius-md); 
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-sm);
        }
        
        .chart-wrapper h3 { 
            margin-bottom: var(--spacing-md); 
            font-weight: 500; 
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
        }
        
        .large-chart {
            height: 400px;
        }
        
        .loading-text, .error-text { 
            text-align: center; 
            padding: var(--spacing-xl); 
            font-size: 1rem; 
            color: var(--text-secondary); 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .loading-text::before {
            content: "🔄";
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        
        .error-text::before {
            content: "⚠️";
            font-size: 2rem;
        }
        
        .animation-step {
            text-align: center;
            padding: var(--spacing-xl);
            font-size: 1.2rem;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            flex-grow: 1;
            height: 100%;
        }

        .animation-step .animation-icon {
            width: 80px;
            height: 80px;
            margin-bottom: var(--spacing-sm);
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4));
        }

        .animation-step .animation-icon svg {
            width: 100%;
            height: 100%;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .chart-wrapper {
                padding: var(--spacing-sm);
            }
        }
        
        @media (max-width: 768px) {
            :root {
                --spacing-md: 12px;
                --spacing-lg: 16px;
            }
            body { padding: var(--spacing-sm); }
            #stats-container { gap: var(--spacing-sm); padding-bottom: var(--spacing-sm); justify-content: center; }
            .stat-item { font-size: 0.8rem; padding: 4px 8px; }
            .stat-item span { font-size: 0.9rem; }
            #filter-container { flex-direction: column; align-items: stretch; }
            #program-filters { justify-content: stretch; flex-direction: column; }
            .filter-btn, .action-button, .nav-back-btn { width: 100%; justify-content: center; }
            .nav-back-btn { order: 0; } /* Reset order for mobile */
            
            .modal-header { flex-direction: column; align-items: flex-start; gap: var(--spacing-sm); }
            .modal-header h2 { font-size: 1.2rem; }
            .modal-footer .modal-close-btn { width: 100%; justify-content: center; }
            
            #ai-chat-modal-content, #initial-note-modal-content { max-width: 95%; }
            .modal-body { padding: var(--spacing-md); }
            
            .chart-container { height: 250px; }
            .large-chart { height: 350px; }
        }
        
        @media (max-width: 480px) {
            h1 { margin-block: 0 var(--spacing-lg); font-size: 1.6rem; }
            nav { padding: var(--spacing-sm); }
            .chart-wrapper h3 { font-size: 0.9rem; }
        }
        
        /* Utility & Text Classes */
        .text-sm { font-size: 0.8rem; }
        .text-center { text-align: center; }
        .mt-md { margin-top: var(--spacing-md); }

        /* AI Chat & Initial Note Content Specific Styles */
        #ai-chat-content-message, .note-body-content {
            padding: var(--spacing-xl);
            text-align: center;
            color: var(--text-primary);
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            gap: var(--spacing-md);
        }
        #ai-chat-content-message .icon { font-size: 3rem; }
        #ai-chat-content-message .main-message {
            font-size: 1.4rem;
            font-weight: 500;
            color: var(--primary-color);
        }
        #ai-chat-content-message .sub-message, .note-body-content p {
            color: var(--text-secondary);
            max-width: 450px;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        #ai-chat-content-message strong, .note-body-content strong {
            color: var(--accent-color);
            font-weight: 600;
        }
        #ai-chat-content-message .disclaimer, .note-body-content .disclaimer {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: var(--spacing-lg);
            border-top: 1px solid var(--glass-border);
            padding-top: var(--spacing-md);
            max-width: 500px;
        }
        #ai-chat-content-message .disclaimer strong, .note-body-content .disclaimer strong {
            color: inherit;
            font-weight: 700;
        }

        .note-body-content .note-link {
            display: inline-block;
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            background-color: var(--secondary-color);
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            transition: all var(--transition-fast);
        }
        .note-body-content .note-link:hover {
            background-color: #00cde7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 182, 203, 0.3);
        }

        /* Custom On-Screen Alert for Mobile & Security */
        #mobile-alert-overlay, #security-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000; /* Higher than other modals */
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        #mobile-alert-overlay.visible, #security-alert-overlay.visible {
            display: flex;
            opacity: 1;
        }
        .mobile-alert-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: var(--shadow-xl);
        }
        .mobile-alert-content h4 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            font-size: 1.2rem;
        }
        .mobile-alert-content p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        #mobile-alert-close-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-xl);
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: background-color var(--transition-fast);
            width: 100%;
        }
        #mobile-alert-close-btn:hover {
            background: var(--primary-color-hover);
        }
        
        #security-alert-close-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-xl);
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: background-color var(--transition-fast);
            width: 100%;
        }
        #security-alert-close-btn:hover {
            background: #d92d36;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wipro Hiring Dashboard</h1>
        <nav>
            <div id="stats-container">
                <div id="deviceIdDisplay" class="stat-item" style="display: none; border-color: var(--primary-color);"></div>
            </div>
            <div id="filter-container">
                <button id="backToMainBtn" class="action-button nav-back-btn">
                    ⬅️ Back to My Data
                </button>
                <div id="program-filters">
                </div>
                <button id="analyze-btn" class="action-button">
                    Analyze Data
                </button>
            </div>
        </nav>
        <div id="dashboardContainer">
            <div class="table-wrapper">
                <table id="dashboardTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="analytics-modal-overlay" class="modal-overlay">
        <div id="analytics-modal-content" class="modal-content">
            <div class="modal-header">
                <h2>Hiring Process Analytics</h2>
                <button id="analytics-modal-close-btn" class="modal-close-btn">
                    Back to Dashboard
                </button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <div id="ai-chat-modal-overlay" class="modal-overlay">
        <div id="ai-chat-modal-content" class="modal-content">
            <div class="modal-header">
                <h2>Important Information</h2>
                <button id="ai-chat-close-btn" class="modal-close-btn">
                    Got it!
                </button>
            </div>
            <div class="modal-body">
                <div id="ai-chat-content-message">
                    <span class="icon">🚧</span>
                    <p class="main-message">My AI Assistant Feature is Under Construction!</p>
                    <p class="sub-message">
                        I'm currently developing a smart assistant to help you track and understand the <strong>Wipro hiring process timelines</strong>. This feature isn't quite ready yet, but thank you for checking it out!
                    </p>
                    <p class="sub-message">
                        Your contribution of data is incredibly valuable and directly helps future batches of applicants. Thank you for your support!
                    </p>
                    <p class="disclaimer">
                        <strong>Disclaimer:</strong> This is an independent, unofficial project for tracking and analyzing hiring process timelines based on crowd-sourced data. <strong>This website is not an official Wipro website and is not affiliated with Wipro Limited in any way.</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="initial-note-overlay" class="modal-overlay">
        <div id="initial-note-modal-content" class="modal-content">
            <div class="modal-header">
                <h2>Welcome & Important Notice</h2>
            </div>
            <div class="modal-body">
                <div class="note-body-content">
                    <p>
                        The data analyzed and displayed on this dashboard is collected from users who voluntarily contribute their hiring process timelines on our main page.
                    </p>
                    <p class="disclaimer">
                        <strong>This data was not collected from Wipro, and this site is not affiliated with or endorsed by Wipro Limited.</strong>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="initial-note-close-btn" class="modal-close-btn">I Understand</button>
            </div>
        </div>
    </div>
    
    <div id="mobile-alert-overlay" class="modal-overlay">
        <div class="mobile-alert-content">
            <h4>A Quick Note 📱</h4>
            <p>For the best experience viewing analytics, please use a laptop or your browser's 'Desktop Site' feature.</p>
            <button id="mobile-alert-close-btn">Got It</button>
        </div>
    </div>

    <div id="security-alert-overlay" class="modal-overlay">
        <div class="mobile-alert-content"> <h4>Action Disabled 🚫</h4>
            <p>For security reasons, developer tools and right-clicking are disabled. Thank you for your understanding.</p>
            <button id="security-alert-close-btn">Okay, Understood</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase & State ---
        const firebaseConfig = { 
            apiKey: "AIzaSyB4-pd9e8VScCzyRuVO7HuqobeFTAKDRPA", 
            authDomain: "self-eef8f.firebaseapp.com", 
            projectId: "self-eef8f", 
            storageBucket: "self-eef8f.appspot.com", 
            messagingSenderId: "452188042250", 
            appId: "1:452188042250:web:8472d7513e904f21a29bf3", 
            measurementId: "G-J889GNQJDT" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let allRecordsCache = [];
        let chartsDrawn = false;
        let currentStats = {};
        
        const programTitles = {
            'WILP': 'WILP',
            'Elite': 'Elite Hiring',
            'EliteExclusive': 'Elite Exclusive',
            'OnCampus': 'On Campus',
            'NTH': 'Elite NTH'
        };
        
        const programColors = ['#8a3ffc', '#33b1ff', '#007d79', '#ff7eb6', '#ba4e00'];
        const chartTheme = {
            backgroundColor: 'transparent',
            titleTextStyle: { color: '#FFFFFF', fontSize: 14, bold: false },
            legend: { textStyle: { color: '#FFFFFF', fontSize: 12 }, position: 'top', alignment: 'center' },
            hAxis: { textStyle: { color: '#FFFFFF', fontSize: 11 }, titleTextStyle: { color: '#FFFFFF', fontSize: 12 }, gridlines: { color: 'transparent' }, minorGridlines: { count: 0 } }, 
            vAxis: { textStyle: { color: '#FFFFFF', fontSize: 11 }, titleTextStyle: { color: '#FFFFFF', fontSize: 12 }, gridlines: { color: 'transparent' }, minorGridlines: { count: 0 } },
            chartArea: { backgroundColor: 'transparent', left: '15%', top: '15%', width: '80%', height: '70%' },
            tooltip: { textStyle: { color: '#333', fontSize: 12 }, showColorCode: true }
        };

        // --- Init ---
        google.charts.load('current', {packages:['corechart', 'bar', 'line']});
        document.addEventListener('DOMContentLoaded', initializeDashboard);

        async function initializeDashboard() {
            // MODIFIED: Check for device ID and redirect if it's missing.
            let deviceId = sessionStorage.getItem('wiproTrackerDeviceId');

            if (deviceId) {
                localStorage.setItem('deviceID', deviceId);
            } else {
                deviceId = localStorage.getItem('deviceID');
            }

            // If no ID is found in session or local storage, redirect to main page.
            if (!deviceId) {
                window.location.href = 'index.html';
                return; // Stop script execution
            }

            // If an ID exists, proceed to load the page.
            const deviceIdDisplay = document.getElementById('deviceIdDisplay');
            deviceIdDisplay.innerHTML = `Your ID: <span>${deviceId}</span>`;
            deviceIdDisplay.style.display = 'flex';

            document.querySelector("#dashboardTable tbody").innerHTML = `
                <tr><td colspan="15" class="loading-text">Loading hiring data...<span class="text-sm text-secondary">Please wait while we fetch the latest records</span></td></tr>`;
            
            document.getElementById('initial-note-overlay').classList.add('visible');

            try {
                const querySnapshot = await getDocs(collection(db, "wipro"));
                const stats = { totalVisits: querySnapshot.size, notFilled: 0, ...Object.fromEntries(Object.values(programTitles).map(title => [title, 0])) };
                
                allRecordsCache = processFirestoreData(querySnapshot, stats);
                stats.filled = stats.totalVisits - stats.notFilled;
                currentStats = stats;

                updateStatsDisplay(stats);
                
                const initialRecordsToDisplay = allRecordsCache.filter(r => r.Program === 'WILP');

                updateTableHeaders('program', initialRecordsToDisplay);
                renderTable(initialRecordsToDisplay, 'program');

                requestAnimationFrame(() => {
                    const wilpButton = document.querySelector('[data-filter="WILP"]');
                    if (wilpButton) {
                        wilpButton.classList.add('active');
                    }
                });

                setupEventListeners();
                
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                document.querySelector("#dashboardTable tbody").innerHTML = `
                    <tr><td colspan="15" class="error-text">Failed to load data<span class="text-sm text-secondary">${error.message || 'Please try again later'}</span></td></tr>`;
            }
        }

        function processFirestoreData(querySnapshot, stats) {
            const records = [];
            const userProgramData = new Map(); 

            for (const doc of querySnapshot.docs) {
                const userData = doc.data();
                const programKeys = Object.keys(userData).filter(key => programTitles[key]);
                const deviceId = doc.id;
                const createdAt = userData.createdAt;
                const ipInfo = userData.ipInfo;
                
                if (programKeys.length === 0) {
                    stats.notFilled++;
                    records.push({ 'Device ID': deviceId, 'CreatedAt': createdAt, 'ipInfo': ipInfo, Program: 'Not Filled' });
                } else {
                    programKeys.forEach(key => {
                        const programName = programTitles[key];
                        stats[programName]++;
                        const formData = userData[key]?.formData || {};
                        let record = { 'Device ID': deviceId, 'CreatedAt': createdAt, 'ipInfo': ipInfo, Program: programName, 'User ID': deviceId, ...formData };
                        records.push(record);

                        if (!userProgramData.has(deviceId)) {
                            userProgramData.set(deviceId, record);
                        }
                    });
                }
            }
            return records.sort((a, b) => (new Date(b.CreatedAt) || 0) - (new Date(a.CreatedAt) || 0));
        }

        function cleanHeader(header) {
            if (typeof header !== 'string') return '';
            const cleaned = header.replace(/^(wilp|elite|exclusive|campus|nth)-/i, '');
            if (cleaned === 'registration') return 'application';
            if (cleaned === 'final-joining' || cleaned === 'onboarding' || cleaned === 'joining') return 'final-joining';
            if (cleaned === 'business' || cleaned === 'technical') return 'tr';
            if (cleaned === 'bg-check') return 'bgv';
            return cleaned;
        }

        function getHeadersForRecords(view, records) {
            if (view === 'ipInfo') {
                return ['Device ID', 'CreatedAt', 'City', 'Country', 'IP'];
            }

            const desiredFlow = [
                'application', 'assessment', 'svar', 'svar-clearance', 'tr', 'hr', 'offer', 'bgv', 'survey', 'survey-count', 'pre-orientation', 'training', 'final-joining', 'location'
            ];

            const availableOriginalKeys = new Set();
            if (records && records.length > 0) {
                const baseFields = ['Device ID', 'CreatedAt', 'ipInfo', 'Program', 'User ID'];
                records.forEach(record => {
                    Object.keys(record).forEach(key => {
                        if (!baseFields.includes(key)) {
                            availableOriginalKeys.add(key);
                        }
                    });
                });
            }

            const orderedOriginalHeaders = [];
            desiredFlow.forEach(flowKey => {
                const matchingOriginalKey = Array.from(availableOriginalKeys).find(
                    originalKey => cleanHeader(originalKey) === flowKey
                );
                if (matchingOriginalKey) {
                    orderedOriginalHeaders.push(matchingOriginalKey);
                }
            });

            return orderedOriginalHeaders;
        }

        function updateTableHeaders(view, records) {
            const originalHeaders = getHeadersForRecords(view, records);
            document.querySelector("#dashboardTable thead").innerHTML = `
                <tr>${originalHeaders.map(h => `<th>${cleanHeader(h)}</th>`).join('')}</tr>`;
        }
        
        function renderTable(records, view) {
            const headers = getHeadersForRecords(view, records);
            const tableBody = document.querySelector("#dashboardTable tbody");
            
            if (records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${headers.length || 1}" class="error-text">No records found<span class="text-sm text-secondary">Try adjusting your filters</span></td></tr>`;
                return;
            }
            
            const rowsHTML = records.map(record => {
                const cells = headers.map(header => {
                    let cellContent;
                    if (view === 'ipInfo') {
                        const ipInfo = record.ipInfo || {};
                        switch(header) {
                            case 'Device ID': cellContent = `<span class="text-xs" style="color: var(--text-tertiary)">${record[header]}</span>`; break;
                            case 'CreatedAt': cellContent = record.CreatedAt ? new Date(record.CreatedAt).toLocaleString() : '<span class="text-tertiary">N/A</span>'; break;
                            case 'City': cellContent = ipInfo.city || '<span class="text-tertiary">Unknown</span>'; break;
                            case 'Country': cellContent = ipInfo.country || '<span class="text-tertiary">Unknown</span>'; break;
                            case 'IP': cellContent = ipInfo.ip ? `<span class="text-xs" style="color: var(--text-tertiary)">${ipInfo.ip}</span>` : '<span class="text-tertiary">N/A</span>'; break;
                            default: cellContent = '<span class="text-tertiary">N/A</span>';
                        }
                    } else { // 'program' view
                        const value = record[header];
                        cellContent = value || '<span class="text-tertiary">N/A</span>';
                    }
                    return `<td>${cellContent}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
            
            tableBody.innerHTML = rowsHTML;
        }
        
        function updateStatsDisplay(stats) {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.querySelectorAll('.stat-item:not(#deviceIdDisplay)').forEach(el => el.remove());
            
            const totalIdStat = document.createElement('div');
            totalIdStat.className = 'stat-item';
            totalIdStat.innerHTML = `Total Visits: <span>${stats.totalVisits}</span>`;
            statsContainer.appendChild(totalIdStat);

            const programsToDisplay = ['WILP', 'Elite Hiring', 'Elite Exclusive', 'On Campus', 'Elite NTH'];
            programsToDisplay.forEach(programName => {
                const statEl = document.createElement('div');
                statEl.className = 'stat-item';
                statEl.innerHTML = `${programName}: <span>${stats[programName] || 0}</span>`;
                statsContainer.appendChild(statEl);
            });

            const filterContainer = document.getElementById('program-filters');
            Object.entries(programTitles).forEach(([key, title]) => {
                if (!filterContainer.querySelector(`[data-filter="${title}"]`)) {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.dataset.filter = title;
                    btn.dataset.view = 'program';
                    btn.innerHTML = `${title}`;
                    filterContainer.appendChild(btn);
                }
            });
        }
        
        function setupEventListeners() {
            const analyticsModalOverlay = document.getElementById('analytics-modal-overlay');
            const aiChatModalOverlay = document.getElementById('ai-chat-modal-overlay');
            const initialNoteOverlay = document.getElementById('initial-note-overlay');
            const mobileAlertOverlay = document.getElementById('mobile-alert-overlay');
            const securityAlertOverlay = document.getElementById('security-alert-overlay');

            document.getElementById('backToMainBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            document.getElementById('filter-container').addEventListener('click', e => {
                if (e.target.closest('.filter-btn')) {
                    document.querySelectorAll('#program-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.closest('.filter-btn').classList.add('active');
                    
                    const view = e.target.closest('.filter-btn').dataset.view;
                    const filter = e.target.closest('.filter-btn').dataset.filter;
                    const filteredRecords = allRecordsCache.filter(r => r.Program === filter);
                    
                    updateTableHeaders(view, filteredRecords);
                    renderTable(filteredRecords, view);

                } else if (e.target.closest('#analyze-btn')) {
                    if (window.innerWidth <= 768) {
                        mobileAlertOverlay.classList.add('visible');
                    }
                    
                    analyticsModalOverlay.classList.add('visible');
                    
                    if (!chartsDrawn) {
                        const runAnalysis = async () => {
                            const modalBody = analyticsModalOverlay.querySelector('.modal-body');
                            const steps = [
                                { text: 'Processing all entries...', svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" color="#a166ff"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14.5V18c0 .55.45 1 1 1s1-.45 1-1v-1.5c0-.55-.45-1-1-1s-1 .45-1 1zm3-3.5H9c-.55 0-1-.45-1-1V8c0-.55.45-1 1-1h5c.55 0 1 .45 1 1v4c0 .55-.45 1-1 1z"></path><path d="M2 12c0 5.52 4.48 10 10 10s10-4.48 10-10S17.52 2 12 2C6.48 2 2 6.48 2 12zm9-5.5V5c0-.55.45-1 1-1s1 .45 1 1v1.5c0 .55-.45 1-1 1s-1-.45-1-1z" opacity=".3"></path></svg>`, duration: 1500 },
                                { text: 'Analyzing hiring funnel...', svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" color="#ff7eb6"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path><path d="M9.5 16A6.5 6.5 0 0 1 3 9.5h2A4.5 4.5 0 0 0 9.5 14v2z" opacity=".3"></path></svg>`, duration: 1500 },
                                { text: 'Building visualizations...', svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" color="#00b6cb"><path d="M5 9.2h3V19H5zM10.6 5h3v14h-3zm5.6 8h3v6h-3z"></path><path d="M19 19V5h-3v14h3zM5 19v-9.8h3V19H5zm5.6 0v-6h3v6h-3z" opacity=".3"></path></svg>`, duration: 2000 }
                            ];
                            const sleep = ms => new Promise(res => setTimeout(res, ms));

                            for (const step of steps) {
                                modalBody.innerHTML = `
                                    <div class="animation-step">
                                        <div class="animation-icon">${step.svg}</div>
                                        <p>${step.text}</p>
                                    </div>`;
                                await sleep(step.duration);
                            }

                            modalBody.innerHTML = `
                                <div class="chart-section"><div class="chart-grid">
                                    <div class="chart-wrapper"><h3>Candidate Distribution by Program</h3><div id="pie_chart_div" class="chart-container"></div></div>
                                    <div class="chart-wrapper"><h3>Candidates per Hiring Stage</h3><div id="bar_chart_div" class="chart-container"></div></div>
                                </div></div>
                                <div class="chart-section"><div class="chart-wrapper"><h3>Candidate Funnel (Average Total Days)</h3><div id="cumulative_duration_chart_div" class="chart-container large-chart"></div></div></div>
                                <div class="chart-section"><div class="chart-wrapper"><h3>Average Duration Between Stages</h3><div id="avg_duration_chart_div" class="chart-container large-chart"></div></div></div>`;
                            
                            drawAllCharts();
                            chartsDrawn = true;
                        };

                        google.charts.setOnLoadCallback(runAnalysis);
                    }
                } else if (e.target.closest('#ask-ai-btn')) {
                    aiChatModalOverlay.classList.add('visible');
                }
            });
            
            // --- Modal Close Handlers ---
            const closeAnalyticsModal = () => analyticsModalOverlay.classList.remove('visible');
            document.getElementById('analytics-modal-close-btn').addEventListener('click', closeAnalyticsModal);
            analyticsModalOverlay.addEventListener('click', e => { if (e.target === analyticsModalOverlay) closeAnalyticsModal(); });

            const closeAIChatModal = () => aiChatModalOverlay.classList.remove('visible');
            document.getElementById('ai-chat-close-btn').addEventListener('click', closeAIChatModal);
            aiChatModalOverlay.addEventListener('click', e => { if (e.target === aiChatModalOverlay) closeAIChatModal(); });

            const closeInitialNote = () => initialNoteOverlay.classList.remove('visible');
            document.getElementById('initial-note-close-btn').addEventListener('click', closeInitialNote);
            initialNoteOverlay.addEventListener('click', e => { if (e.target === initialNoteOverlay) closeInitialNote(); });
            
            const closeMobileAlert = () => mobileAlertOverlay.classList.remove('visible');
            document.getElementById('mobile-alert-close-btn').addEventListener('click', closeMobileAlert);
            mobileAlertOverlay.addEventListener('click', e => { if (e.target === mobileAlertOverlay) closeMobileAlert(); });

            const showSecurityAlert = () => securityAlertOverlay.classList.add('visible');
            const closeSecurityAlert = () => securityAlertOverlay.classList.remove('visible');
            
            document.getElementById('security-alert-close-btn').addEventListener('click', closeSecurityAlert);
            securityAlertOverlay.addEventListener('click', e => { if (e.target === securityAlertOverlay) closeSecurityAlert(); });

            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                showSecurityAlert();
            });

            document.addEventListener('keydown', e => {
                const key = e.key.toUpperCase();
                if (
                    e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && key === 'I') ||
                    (e.ctrlKey && e.shiftKey && key === 'C') ||
                    (e.ctrlKey && e.shiftKey && key === 'J') ||
                    (e.ctrlKey && key === 'U')
                ) {
                    e.preventDefault();
                    showSecurityAlert();
                }
            });
            
            window.addEventListener('resize', () => { 
                if (chartsDrawn && analyticsModalOverlay.classList.contains('visible')) { drawAllCharts(); } 
            });
        }
        
        function drawAllCharts() {
            const graphStageOrder = ['application', 'assessment', 'svar', 'svar-clearance', 'tr', 'hr', 'offer', 'bgv', 'survey', 'pre-orientation', 'training', 'final-joining'];

            const chartData = {
                stageCounts: Object.fromEntries(graphStageOrder.map(s => [s, 0])),
                stageDurations: {},
                cumulativeDurations: Object.fromEntries(graphStageOrder.map(s => [s, []])),
                programCounts: {}
            };

            allRecordsCache.forEach(record => {
                if (record.Program === 'Not Filled') return;
                
                chartData.programCounts[record.Program] = (chartData.programCounts[record.Program] || 0) + 1;
                
                let appStages = { dates: {} };
                
                Object.keys(record).forEach(fieldId => {
                    const cleanName = cleanHeader(fieldId);
                    if (graphStageOrder.includes(cleanName) && record[fieldId]) {
                        const stageDate = new Date(record[fieldId]);
                        if (!isNaN(stageDate)) {
                            appStages.dates[cleanName] = stageDate;
                        }
                    }
                });

                Object.keys(appStages.dates).forEach(stage => {
                    if (chartData.stageCounts.hasOwnProperty(stage)) {
                            chartData.stageCounts[stage]++;
                    }
                });

                const regDate = appStages.dates['application'];
                if (regDate) {
                    graphStageOrder.forEach(stage => {
                        if (appStages.dates[stage]) { 
                            const cumulDuration = (appStages.dates[stage] - regDate) / (1000 * 60 * 60 * 24); 
                            if (cumulDuration >= 0) {
                                chartData.cumulativeDurations[stage].push(cumulDuration); 
                            }
                        }
                    });
                }
                
                for (let i = 0; i < graphStageOrder.length - 1; i++) {
                    const currentStage = graphStageOrder[i];
                    const nextStage = graphStageOrder[i + 1];
                    
                    if (appStages.dates[currentStage] && appStages.dates[nextStage]) {
                        const duration = (appStages.dates[nextStage] - appStages.dates[currentStage]) / (1000 * 60 * 60 * 24);
                        if (duration >= 0 && duration < 365) {
                            const stageName = `${currentStage} → ${nextStage}`;
                            if (!chartData.stageDurations[stageName]) {
                                chartData.stageDurations[stageName] = [];
                            }
                            chartData.stageDurations[stageName].push(duration);
                        }
                    }
                }
            });

            drawPieChart(chartData.programCounts);
            drawBarChart(chartData.stageCounts, graphStageOrder);
            drawCumulativeDurationChart(chartData.cumulativeDurations, graphStageOrder);
            drawAverageDurationChart(chartData.stageDurations, graphStageOrder);
        }

        function drawPieChart(programCounts) {
            const pieDiv = document.getElementById('pie_chart_div');
            const data = google.visualization.arrayToDataTable([['Program', 'Count'], ...Object.entries(programCounts).sort((a, b) => b[1] - a[1])]);
            const pieOptions = { 
                ...chartTheme, 
                pieHole: 0.4, 
                is3D: false, 
                colors: programColors, 
                pieSliceText: 'value', 
                pieSliceTextStyle: { color: 'white', fontSize: 12 }, 
                legend: { position: 'labeled', textStyle: { color: '#FFFFFF', fontSize: 12 } }, 
                chartArea: { left: 10, top: 20, width: '100%', height: '80%' }, 
                tooltip: { text: 'percentage' } 
            };
            if (window.innerWidth < 768) { 
                pieOptions.legend.position = 'bottom'; 
                pieOptions.chartArea.height = '70%'; 
                pieOptions.legend.textStyle.fontSize = 10;
            }
            try { 
                new google.visualization.PieChart(pieDiv).draw(data, pieOptions); 
            } catch (error) { 
                pieDiv.innerHTML = `<div class="error-text">Could not display pie chart<span class="text-sm text-secondary">${error.message || 'Data format error'}</span></div>`; 
            }
        }
        
        function drawBarChart(stageCounts, stageOrder) {
            const barDiv = document.getElementById('bar_chart_div');
            const data = google.visualization.arrayToDataTable([
                ['Stage', 'Candidates', { role: 'style' }, { role: 'annotation' }], 
                ...stageOrder.map(s => [s, stageCounts[s], programColors[3], stageCounts[s].toString()])
            ]);
            
            const barOptions = { 
                ...chartTheme, 
                bars: 'horizontal', 
                colors: [programColors[3]], 
                legend: { position: 'none' }, 
                bar: { groupWidth: '75%' }, 
                hAxis: { minValue: 0, textPosition: 'none', gridlines: { count: 0 }, baselineColor: 'transparent' }, 
                chartArea: { left: 150, top: 20, width: '75%', height: '80%' },
                annotations: { textStyle: { fontSize: 13, bold: true, color: '#FFFFFF', auraColor: 'none' } } 
            };
            
            if (window.innerWidth < 768) { 
                barOptions.chartArea.left = 110; 
                barOptions.chartArea.width = '70%';
                barOptions.vAxis.textStyle.fontSize = 10;
                barOptions.annotations.textStyle.fontSize = 11;
            }
            if (window.innerWidth < 480) {
                barOptions.chartArea.left = 80;
                barOptions.chartArea.width = '75%';
                barOptions.vAxis.textStyle.fontSize = 9;
                barOptions.annotations.textStyle.fontSize = 10;
            }
            
            try { 
                new google.visualization.BarChart(barDiv).draw(data, barOptions); 
            } catch (error) { 
                barDiv.innerHTML = `<div class="error-text">Could not display bar chart<span class="text-sm text-secondary">${error.message || 'Data format error'}</span></div>`; 
            }
        }
        
        function drawAverageDurationChart(stageDurations, stageOrder) {
            const avgDiv = document.getElementById('avg_duration_chart_div');
            const avgData = [['Stage Transition', 'Average Days', { role: 'style' }, { role: 'annotation' }]];
            
            for (let i = 0; i < stageOrder.length - 1; i++) {
                const stageName = `${stageOrder[i]} → ${stageOrder[i+1]}`;
                const durations = stageDurations[stageName];
                if (durations && durations.length > 0) {
                    const avg = durations.reduce((a, b) => a + b, 0) / durations.length;
                    avgData.push([stageName, parseFloat(avg.toFixed(1)), programColors[2], avg.toFixed(1)]);
                }
            }
            
            if (avgData.length <= 1) { 
                avgDiv.innerHTML = `<div class="error-text">Not enough sequential stage data<span class="text-sm text-secondary">Cannot calculate average durations</span></div>`; 
                return; 
            }
            
            const data = google.visualization.arrayToDataTable(avgData);
            const avgDurationsOptions = { 
                ...chartTheme, 
                bars: 'horizontal', 
                legend: { position: 'none' }, 
                bar: { groupWidth: '75%' }, 
                hAxis: { minValue: 0, title: 'Average Days Between Stages', titleTextStyle: { color: '#FFFFFF', fontSize: 12 }, textPosition: 'none', gridlines: { count: 0 }, baselineColor: 'transparent' }, 
                chartArea: { left: 200, top: 20, width: '70%', height: '80%' }, 
                annotations: { textStyle: { fontSize: 12, color: '#FFFFFF', auraColor: 'none' } } 
            };
            
            if (window.innerWidth < 768) { 
                avgDurationsOptions.chartArea.left = 150; 
                avgDurationsOptions.chartArea.width = '65%';
                avgDurationsOptions.vAxis.textStyle.fontSize = 10;
            }
             if (window.innerWidth < 480) {
                avgDurationsOptions.chartArea.left = 120;
                avgDurationsOptions.chartArea.width = '60%';
                avgDurationsOptions.vAxis.textStyle.fontSize = 9;
            }
            
            try { 
                new google.visualization.BarChart(avgDiv).draw(data, avgDurationsOptions); 
            } catch (error) { 
                avgDiv.innerHTML = `<div class="error-text">Could not display duration chart<span class="text-sm text-secondary">${error.message || 'Data format error'}</span></div>`; 
            }
        }

        function drawCumulativeDurationChart(cumulativeDurations, stageOrder) {
            const funnelDiv = document.getElementById('cumulative_duration_chart_div');
            const avgData = [['Stage', 'Average Cumulative Days', { role: 'style' }, { role: 'annotation' }]];
            
            stageOrder.forEach(stage => {
                const durations = cumulativeDurations[stage];
                if (durations && durations.length > 0) {
                    const avg = durations.reduce((a, b) => a + b, 0) / durations.length;
                    avgData.push([ stage, parseFloat(avg.toFixed(1)), programColors[0], `${avg.toFixed(1)} days` ]);
                }
            });

            if (avgData.length <= 1) {
                funnelDiv.innerHTML = `<div class="error-text">Not enough data for funnel chart<span class="text-sm text-secondary">Requires application dates</span></div>`;
                return;
            }
            
            const data = google.visualization.arrayToDataTable(avgData);
            const funnelOptions = {
                ...chartTheme,
                bars: 'horizontal',
                legend: { position: 'none' },
                bar: { groupWidth: '75%' },
                hAxis: { minValue: 0, title: 'Average Cumulative Days Since Application', titleTextStyle: { color: '#FFFFFF', fontSize: 12 }, textPosition: 'none', gridlines: { count: 0 }, baselineColor: 'transparent' },
                chartArea: { left: 150, top: 20, width: '75%', height: '80%' },
                annotations: { textStyle: { fontSize: 13, bold: true, color: '#FFFFFF', auraColor: 'none' } }
            };

            if (window.innerWidth < 768) {
                funnelOptions.chartArea.left = 110;
                funnelOptions.chartArea.width = '70%';
                funnelOptions.vAxis.textStyle.fontSize = 10;
                funnelOptions.annotations.textStyle.fontSize = 11;
            }
            if (window.innerWidth < 480) {
                funnelOptions.chartArea.left = 80;
                funnelOptions.chartArea.width = '75%';
                funnelOptions.vAxis.textStyle.fontSize = 9;
                funnelOptions.annotations.textStyle.fontSize = 10;
            }

            try {
                new google.visualization.BarChart(funnelDiv).draw(data, funnelOptions);
            } catch (error) {
                funnelDiv.innerHTML = `<div class="error-text">Could not display funnel chart<span class="text-sm text-secondary">${error.message || 'Data format error'}</span></div>`;
            }
        }
    </script>
</body>
</html>